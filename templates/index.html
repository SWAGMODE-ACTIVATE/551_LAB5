<!DOCTYPE html>

    <head>
        <title>temperature Map</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	    <link rel="stylesheet" href="/static/styles/pagestyle.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    </head>

    <body>
        <h1>temperature map</h1>
        <p id="coolmessage">gya</p>
        <p></p>
        <p>input host and port</p>
        <form id="mqttform">
            <label>broker:</label>
            <input type="text" id="broker" value="test.mosquitto.org" required>
            
            <label>port:</label>
            <input type="number" id="port" value="8080" required>
            
            <button type="submit">start</button>
            <button type="button" id="disconnect" disabled>end</button>
            <button type="button" id="share" disabled>share my status</button>
        </form>











        <div id="map" style="width: 1200px; height: 580px; margin: 0 auto"></div>
        <p class="warning">{{ message }}</p>
        <h3>search for building permits between two given dates!</h3>
        <form id="searcher" action = "{{ url_for('index') }}" method="POST">
            <div style="display: flex; justify-content: center; gap: 6px; align-items: center; margin-bottom: 10px;">
                <input name="from_date" type="date" id="start">
                <span style="margin: 0 5px; padding: 0;">until: </span>
                <input name="till_date" type="date" id="till">
            </div>
            <button>search</button>
        </form>
    </body>

    <script>
    const topic = "ENGO551/nick_kennedy/my_temperature";
    
    document.getElementById("mqttform").addEventListener("submit", (event) => {
            event.preventDefault();

            const broker = document.getElementById("broker").value;
            const port = Number(document.getElementById("port").value);

            mqtt = new Paho.MQTT.Client(broker, port, "orderform-" + Math.random());
            mqtt.onmessagearrived=onmessagearrived;
            mqtt.onconnectionlost=onconnectionlost;
            mqtt.connect({
                onSuccess: () => {
                    console.log("connected");
                    mqtt.subscribe(topic);
                    document.querySelector("button[type='submit']").disabled = true;
                    document.getElementById("disconnect").disabled = false;
                    document.getElementById("share").disabled = false;
                },
                onFailure: (err) => console.error("erorr:", err)
            })
        })
        
    document.getElementById("disconnect").addEventListener("click", () => {
        if (mqtt) {
            mqtt.disconnect();
            console.log("disconnected");
            document.querySelector("button[type='submit']").disabled = false;
            document.getElementById("disconnect").disabled = true;
            document.getElementById("share").disabled = true;
            
        }
        })
    
    
    document.getElementById("share").addEventListener("click", () => {
    if (mqtt) {
        document.getElementById("coolmessage").innerHTML = "sharing"
        if ("geolocation" in navigator){
            navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude
            const long = position.coords.longitude
            const temp = Math.floor(Math.random()*(60 + 40)-40)
            const geojson = {
                type: "Feature",
                properties: {temp},
                geometry: {type: "Point", coordinates: [long, lat]}
            }
            
            const geojsonstring = JSON.stringify(geojson)
            console.log(geojsonstring)
            })
        }
        else{
            document.getElementById("coolmessage").innerHTML = "geolocation not supported in your browser."
        }


        
    }
    })
    
    
    
    
    
    
    
    
    
    
    
    var map = L.map('map', {
        center: [51,-114],
        zoom:10
    });
    
    var tile = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'})

    tile.addTo(map)

    var tile2 = L.tileLayer(
            'https://api.mapbox.com/styles/v1/blackgoatlaughs/cm83dqgdz000401so9cldhct2/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYmxhY2tnb2F0bGF1Z2hzIiwiYSI6ImNtODNkYnYxaTBtcmEybHB3MnJ2bGQwNHkifQ.OYZqlOXTklXs9dHyt1WDjA',
            {
              maxZoom: 19,
              attribution:
                '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> Â© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> <strong><a href="https://labs.mapbox.com/contribute/" target="_blank">Improve this map</a></strong>'
            }
          )

    tile2.addTo(map)


    function onmessagearrived(msg){
        console.log(msg.payloadString)
    }

    function onconnectionlost(){
        console.log("connection lost")
    }

    </script> 
</html>